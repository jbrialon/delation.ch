<!DOCTYPE html>
<html >
<head>
    <meta charset="UTF-8">
    <meta name="google" value="notranslate">


    <title>Délation.ch</title>

    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">

    <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css'>
    <link rel='stylesheet prefetch' href='http://blackrockdigital.github.io/startbootstrap-agency/css/agency.css'>
    <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Montserrat:400,700'>
    <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Kaushan+Script'>
    <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic'>
    <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700'>

    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <style>

        html{
            width: 100%;
            overflow-x: hidden;
        }
        body{
            width: 100%;
            overflow-x: hidden;
        }

        header:before {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        header {
            position: relative;
            background-attachment: fixed;
            background-size: cover;
            background-image: url("img/mathew.jpg");
            background-repeat: no-repeat;
            background-position: center center;
            min-height: 100vh;
        }

        .intro-text {
            text-shadow: 0px 0px 50px rgba(0, 0, 0, 0.5);
        }

        .uploader-holder{
            position: relative;
            font-family: Montserrat,"Helvetica Neue",Helvetica,Arial,sans-serif;
            font-size: 30px;
            font-weight: 700;
            color:white;
            height: 200px;
            width: 100%;
            display: table;
        }

        .uploader-holder input{
            opacity: 0;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 2;
        }

        .uploader-holder canvas{
            position: absolute;
            top: 0;
            left: 50%;
            margin-left: -100px;
            z-index: 1;
        }
        .uploader-holder .btn{
            vertical-align: middle;
            display: table-cell;
            background: rgb(51, 51, 51);
            color:white;
            boder-color: rgb(51, 51, 51);
        }

    </style>

    <script>
      window.console = window.console || function(t) {};
      window.open = function(){ console.log("window.open is disabled."); };
      window.print   = function(){ console.log("window.print is disabled."); };
  </script>

  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

</head>

<body>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="intro-text">
                <div class="intro-lead-in">Dénonce</div>
                <div class="intro-heading" id="words">
                    &nbsp;
                </div>
                <a href="#" class="btn btn-xl" id="introBtn">dénoncer</a>
            </div>
        </div>
    </header>

    <section id="contact">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Formulaire de délation</h2>
                    <h3 class="section-subheading text-muted">Parce que ça fait toujours du bien d'être un connard.</h3>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3">
                    <form name="sentMessage" id="contactForm" novalidate="" action="form.php">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Qui es-tu ? (ton nom ne seras pas divulgué) *" id="delator" required>
                                    <p class="help-block text-danger"></p>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Qui veux-tu dénoncer ? *" id="name" required>
                                    <p class="help-block text-danger"></p>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <textarea class="form-control" placeholder="Que lui reproches-tu ? *" id="message" required></textarea>
                                    <p class="help-block text-danger"></p>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                            <div class="col-md-12 text-center">
                                <div class="form-group uploader-holder">
                                    <canvas width='200' height='200' id='canvas'></canvas>
                                    <input type='file' id='upload' />
                                    <div class="btn btn-xl" id="uploadBtn">Preuve photo à l'appui</div>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                            <div class="col-md-12 text-center">
                                <div class="form-group">
                                    <div class="g-recaptcha" data-sitekey="6LejcAgTAAAAADqd_JsO8QDBddtPMex1bgKCkL2Z" style="display:inline-block;"></div>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                            <div class="col-lg-12 text-center">
                                <div id="success"></div>
                                <button type="submit" class="btn btn-xl">Envoyer</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <section id="wall">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Mur de la délation</h2>
                    <h3 class="section-subheading text-muted">Ils se sont fait dénoncer.</h3>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <ul class="timeline" id="timeline">
                    </ul>
                </div>
            </div>
        </div>
    </section>
    <script src="http://assets.codepen.io/assets/common/stopExecutionOnTimeout-6c99970ade81e43be51fa877be0f7600.js"></script>

    <script src='http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/gsap/1.17.0/plugins/ScrollToPlugin.min.js'></script>
    <script type="text/template" class="template" id="timelineTpl">
        <% _.each( timelineItems, function( item, i ){ %>
        <li class="<%= (i % 2 !== 0) ? 'timeline-inverted' : '' %>">
            <div class="timeline-image">
                <img src="<%- (item.attributes.picture) ? item.attributes.picture : 'http://loremflickr.com/200/200/people/?rand='+Math.random() %>" class="img-circle img-responsive" alt="" />
            </div>
            <div class="timeline-panel">
                <div class="timeline-heading">
                    <h4><%- item.attributes.name %></h4>
                </div>
                <div class="timeline-body">
                    <p class="text-muted"><%- item.attributes.message %></p>
                </div>
            </div>
        </li>
        <% }); %>
    </script>
    <script>
      var words = [
      'Matthieu',
      'ton voisin',
      'ta copine',
      'tes coll\xE8gues',
      'ta grand-m\xE8re',
      'ton fr\xE8re',
      'ton meilleur ami',
      'ton ex',
      'ton banquier',
      'ton boss',
      'le chien du voisin',
      'le facteur',
      'toi m\xEAme',
      'les frontaliers',
      'ma femme'
      ], i = 0;
      $('#words').html(words[i]);
      var tl = new TimelineMax({
        delay: 3,
        repeat: -1,
        repeatDelay: 2,
        paused: true
    });
      tl.to('#words', 0.8, {
        autoAlpha: 0,
        scale: 2
    });
      tl.addCallback(function () {
        i++;
        if (i > words.length - 1) {
            i = 0;
        }
        ;
        $('#words').html(words[i]);
    });
      tl.set('#words', { scale: 0.8 });
      tl.to('#words', 1, {
        autoAlpha: 1,
        scale: 1
    });
      tl.play();
      $('#introBtn').on('click', function () {
        TweenMax.to(window, 1, {
            scrollTo: { y: $('#contact').position().top },
            ease: Power2.easeOut
        });
        return false;
    });

  </script>

  <script type="text/javascript">

    Parse.initialize("x1ZqMweKkVWNx5YhhzbKqvDbXBartc9M2qzJMCPM", "Xu9xZFPyjwZ1l1F3zmCyhFbafyZnq6BPoIq3Jj2f");
    var TestObject = Parse.Object.extend("TestObject");
    var query = new Parse.Query(TestObject);
    query.descending("createdAt");

    var updateDelationWall = function(scroll){

        query.find({
          success: function(testObjects) {
            console.log(testObjects);
            var html = '';
            var template = _.template(
                $( "#timelineTpl" ).html()
            );
            $('#timeline').html( template( {timelineItems : testObjects} ) );
            if(scroll){
                TweenMax.to(window, 1, {
                    scrollTo: { y: $('#wall').position().top },
                    ease: Power2.easeOut
                });
            }
            // The object was retrieved successfully.
          },
          error: function(object, error) {
            console.log(object, error);
            // The object was not retrieved successfully.
            // error is a Parse.Error with an error code and message.
          }
        });

    };

    // Attach event listener
    document.getElementById('upload').addEventListener('change', doUpload);

    // Take event from file change & handle it
    function doUpload(e){
        // The user might upload multiple files, we'll take the first
        var file = e.target.files[0];

        // Check that there is a file uploaded
        if(file){
            // We need to use a FileReader to actually read the file.
            var reader = new FileReader();

            // When it's loaded, we'll send the image data to the canvas method
            reader.onload = function(event){
                canvasLoadImage(event.target.result);
            }

            // Pass the reader the file to read and give us the DataURL
            reader.readAsDataURL(file);
        }
    }

    var datas;

    // Handle the returned image data
    function canvasLoadImage(imgData){
        // Create a New Imgae
        var img = new Image();

        // Assign the image data as the source - as we are using a data URL
        img.src = imgData;

        // Always use onload with images!
        img.onload = function(){

            // Load the Canvas & Context
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            var width = Math.round(this.width * 200 / this.height);
            // Draw the image
            context.drawImage(img, 0, 0, width, 200);

            datas = canvas.toDataURL("image/jpg");
        }
        $('#uploadBtn').addClass('hidden');
    }

    updateDelationWall();

    $('#contactForm').on('submit', function(e){

        var dataValues = {
            name: $('#name').val(),
            delator: $('#delator').val(),
            message: $('#message').val(),
            picture: datas
        }
        var sendValues = $.extend( {}, dataValues, {'g-recaptcha-response' : grecaptcha.getResponse()} );

        $.ajax({
            url: $(e.currentTarget).attr('action'),
            type: "POST",
            data: sendValues
        })
        .done(function(resp){

            var decodedResp = JSON.parse(resp);
            if(decodedResp.valid === true){

                var TestObject = Parse.Object.extend("TestObject");
                var testObject = new TestObject();
                testObject
                .save(dataValues)
                .then(function(object) {
                  alert(decodedResp.message);
                  updateDelationWall(true);
                });

            }else{
                alert(decodedResp.message);
            }

        });
        return false;
    });

  </script>


</body>
</html>
